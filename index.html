<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ - æ”¹å–„ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 450px; width: 100%; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    
    <!-- é–‹å§‹ç”»é¢ -->
    <div id="startScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="bg-green-500 p-4 rounded-2xl inline-block mb-4">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
                <p class="text-gray-500">æ”¹å–„ç‰ˆ - è¦‹ã‚„ã™ã„åœ°å›³</p>
            </div>
            
            <div class="space-y-3">
                <button onclick="getLocation()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl hover:bg-green-600 transition-colors">
                    ğŸ“ ç¾åœ¨åœ°ã‚’ä½¿ã†
                </button>
                
                <button onclick="startDemo()" class="w-full bg-gray-600 text-white font-bold py-4 rounded-xl hover:bg-gray-700 transition-colors">
                    ğŸ® ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§è©¦ã™ï¼ˆæ±äº¬é§…ï¼‰
                </button>
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>âœ¨ æ–°æ©Ÿèƒ½:</strong> Googleãƒãƒƒãƒ—é€£æºãƒ»è¦‹ã‚„ã™ã„åœ°å›³ãƒ»æ­£ç¢ºãªè·é›¢
                </p>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="max-w-4xl mx-auto space-y-6 hidden">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
                    <p class="text-sm text-gray-500">æ”¹å–„ç‰ˆ - æº–å‚™å®Œäº†ï¼</p>
                </div>
                <button onclick="toggleSettings()" class="p-3 rounded-xl hover:bg-gray-100">
                    âš™ï¸
                </button>
            </div>
        </div>

        <!-- è¨­å®š -->
        <div id="settingsPanel" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h2 class="text-lg font-bold mb-4">ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«</h2>
            <div class="space-y-3">
                <label class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="mapStyle" value="voyager" checked class="w-5 h-5">
                    <div>
                        <div class="font-medium">æ¨™æº–ï¼ˆãŠã™ã™ã‚ï¼‰</div>
                        <div class="text-sm text-gray-500">è¦‹ã‚„ã™ã„ãƒ‡ã‚¶ã‚¤ãƒ³</div>
                    </div>
                </label>
                
                <label class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="mapStyle" value="osm" class="w-5 h-5">
                    <div>
                        <div class="font-medium">è©³ç´°</div>
                        <div class="text-sm text-gray-500">æƒ…å ±é‡å¤šã‚</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- æ­©æ•°è¨­å®š -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="font-medium mb-3">ç›®æ¨™æ­©æ•°</h2>
            <div class="flex items-center gap-4">
                <input type="range" id="stepsRange" min="1000" max="20000" step="500" value="5000" 
                    class="flex-1 h-2 bg-gray-200 rounded-lg cursor-pointer accent-green-500"
                    oninput="updateSteps(this.value)">
                <div class="text-right min-w-32">
                    <div id="stepsDisplay" class="text-3xl font-bold text-green-600">5,000</div>
                    <div id="distanceDisplay" class="text-sm text-gray-500">æ­© (3.5km)</div>
                </div>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="setSteps(3000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">3åƒæ­©</button>
                <button onclick="setSteps(5000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">5åƒæ­©</button>
                <button onclick="setSteps(10000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">1ä¸‡æ­©</button>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆä½œæˆãƒœã‚¿ãƒ³ -->
        <button onclick="createRoute()" id="createRouteBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition-all">
            ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ
        </button>

        <!-- åœ°å›³ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-lg font-bold mb-4">ğŸ“ åœ°å›³</h2>
            <div id="map" class="rounded-xl border-2 border-gray-200"></div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆæƒ…å ± -->
        <div id="routeInfo" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h2 class="text-lg font-bold mb-4">ğŸ“Š ãƒ«ãƒ¼ãƒˆæƒ…å ±</h2>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div id="routeDistance" class="text-2xl font-bold text-green-600">0</div>
                    <div class="text-sm text-gray-600">km</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div id="routeSteps" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-600">æ­©</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl text-center">
                    <div id="routeTime" class="text-2xl font-bold text-purple-600">0</div>
                    <div class="text-sm text-gray-600">åˆ†</div>
                </div>
            </div>

            <!-- Googleãƒãƒƒãƒ—ã§é–‹ããƒœã‚¿ãƒ³ -->
            <button id="openInGoogleMaps" onclick="openInGoogleMaps()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition-colors mb-3">
                ğŸ“± Googleãƒãƒƒãƒ—ã§é–‹ã
            </button>

            <div id="routePreferences" class="text-center text-sm text-gray-500"></div>
        </div>

        <!-- ãƒ’ãƒ³ãƒˆ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="font-bold mb-3">ğŸ’¡ æ”¹å–„ç‚¹</h3>
            <ul class="space-y-2 text-sm text-gray-600">
                <li>âœ… ã‚ˆã‚Šè¦‹ã‚„ã™ã„åœ°å›³ãƒ‡ã‚¶ã‚¤ãƒ³</li>
                <li>âœ… å®Ÿéš›ã®æ­©æ•°ã«è¿‘ã„è·é›¢ã®ãƒ«ãƒ¼ãƒˆç”Ÿæˆ</li>
                <li>âœ… Googleãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªã¨é€£æº</li>
            </ul>
        </div>

    </div>

    <script>
        let map = null;
        let userLocation = null;
        let currentSteps = 5000;
        let routeLayer = null;
        let currentRoute = null;

        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        function startDemo() {
            console.log('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰é–‹å§‹');
            userLocation = { lat: 35.6812, lng: 139.7671 };
            showMainScreen();
        }

        // ç¾åœ¨åœ°å–å¾—
        function getLocation() {
            console.log('ç¾åœ¨åœ°å–å¾—é–‹å§‹');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        console.log('ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ');
                        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        showMainScreen();
                    },
                    (error) => {
                        console.error('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼', error);
                        alert('ä½ç½®æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                    }
                );
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
            }
        }

        // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
        function showMainScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            setTimeout(() => {
                console.log('åœ°å›³åˆæœŸåŒ–é–‹å§‹', userLocation);
                map = window.L.map('map').setView([userLocation.lat, userLocation.lng], 15);
                
                // è¦‹ã‚„ã™ã„ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆCartoDB Voyagerï¼‰
                window.L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'Â© OpenStreetMap contributors Â© CARTO',
                    maxZoom: 19
                }).addTo(map);

                window.L.marker([userLocation.lat, userLocation.lng])
                    .addTo(map)
                    .bindPopup('ğŸ“ ç¾åœ¨åœ°')
                    .openPopup();
                
                console.log('åœ°å›³åˆæœŸåŒ–å®Œäº†');
            }, 100);
        }

        // è¨­å®šãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆ
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        // æ­©æ•°æ›´æ–°
        function updateSteps(value) {
            currentSteps = parseInt(value);
            document.getElementById('stepsDisplay').textContent = currentSteps.toLocaleString();
            const distance = ((currentSteps * 0.7) / 1000).toFixed(1);
            document.getElementById('distanceDisplay').textContent = `æ­© (${distance}km)`;
        }

        // æ­©æ•°è¨­å®š
        function setSteps(value) {
            currentSteps = value;
            document.getElementById('stepsRange').value = value;
            updateSteps(value);
        }

        // ãƒ«ãƒ¼ãƒˆä½œæˆ
        async function createRoute() {
            if (!map || !userLocation) {
                alert('åœ°å›³ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }

            console.log('ãƒ«ãƒ¼ãƒˆä½œæˆé–‹å§‹');

            const button = document.getElementById('createRouteBtn');
            button.disabled = true;
            button.textContent = 'â³ ãƒ«ãƒ¼ãƒˆä½œæˆä¸­...';

            // å¤ã„ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤
            if (routeLayer) {
                map.removeLayer(routeLayer);
                console.log('å¤ã„ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }

            try {
                // ç›®æ¨™è·é›¢ã‚’è¨ˆç®—ï¼ˆkmï¼‰
                const targetDistance = (currentSteps * 0.7) / 1000;
                
                // ã‚ˆã‚Šæ­£ç¢ºãªã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆï¼ˆè·é›¢ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
                const waypoints = generateBetterWaypoints(userLocation, targetDistance);
                
                // OSRM APIã‚’ä½¿ã£ã¦ãƒ«ãƒ¼ãƒˆã‚’å–å¾—
                const route = await fetchRoute(waypoints);
                
                if (route) {
                    // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆã‚’ä¿å­˜ï¼ˆGoogleãƒãƒƒãƒ—é€£æºç”¨ï¼‰
                    currentRoute = route;

                    // åœ°å›³ã«ãƒ«ãƒ¼ãƒˆæç”»
                    const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    routeLayer = window.L.polyline(coordinates, { 
                        color: '#22c55e', 
                        weight: 6,
                        opacity: 0.8
                    }).addTo(map);

                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

                    // ãƒ«ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤º
                    const actualDistance = (route.distance / 1000).toFixed(1);
                    const actualSteps = Math.round((route.distance / 1000) / 0.7 * 1000);
                    
                    // æ™‚é–“è¨ˆç®—ã‚’è·é›¢ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ï¼ˆã‚ˆã‚Šæ­£ç¢ºï¼‰
                    // æ•£æ­©ãƒšãƒ¼ã‚¹: æ™‚é€Ÿ4km = 1kmã‚ãŸã‚Š15åˆ†
                    const timeMinutes = Math.round((route.distance / 1000) * 15);
                    
                    document.getElementById('routeDistance').textContent = actualDistance;
                    document.getElementById('routeSteps').textContent = actualSteps.toLocaleString();
                    document.getElementById('routeTime').textContent = timeMinutes;
                    
                    document.getElementById('routeInfo').classList.remove('hidden');
                    
                    console.log('ãƒ«ãƒ¼ãƒˆä½œæˆå®Œäº† - è·é›¢:', actualDistance, 'km');
                } else {
                    alert('ãƒ«ãƒ¼ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®æ­©æ•°ã§è©¦ã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ«ãƒ¼ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ';
            }
        }

        // æ”¹å–„ã•ã‚ŒãŸã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ€§å¼·åŒ– + å¼•ãè¿”ã—é˜²æ­¢ + æ­£ç¢ºãªè·é›¢ï¼‰
        function generateBetterWaypoints(center, targetDistanceKm) {
            const waypoints = [center];
            
            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆæ¯å›ç¢ºå®Ÿã«é•ã†ãƒ«ãƒ¼ãƒˆï¼‰
            const timeSeed = Date.now() % 1000 / 1000;
            
            // ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’3-5ã§ãƒ©ãƒ³ãƒ€ãƒ 
            const numWaypoints = 3 + Math.floor(Math.random() * 3);
            
            // åŠå¾„ã‚’å¤§ãã‚ã«ï¼ˆå¼•ãè¿”ã—ã‚’é˜²ãé‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼‰
            const radiusKm = targetDistanceKm / 5.5;
            
            // åˆæœŸè§’åº¦ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ï¼ˆæ¯å›é•ã†ãƒ«ãƒ¼ãƒˆã«ãªã‚‹ï¼‰
            const startAngle = Math.random() * Math.PI * 2 + timeSeed * Math.PI;
            
            console.log('ğŸ”„ æ–°ã—ã„ãƒ«ãƒ¼ãƒˆç”Ÿæˆé–‹å§‹ - ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆæ•°:', numWaypoints, 'ã‚¿ã‚¤ãƒ ã‚·ãƒ¼ãƒ‰:', timeSeed.toFixed(3));
            
            for (let i = 0; i < numWaypoints; i++) {
                // å‡ç­‰é…ç½®ï¼ˆå¼•ãè¿”ã—ã‚’é˜²ããŸã‚ã€ååˆ†ãªè§’åº¦å·®ã‚’ç¢ºä¿ï¼‰
                const baseAngle = (Math.PI * 2 / numWaypoints) * i;
                // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ï¼ˆæ¯å›é•ã†å€¤ï¼‰
                const randomOffset = (Math.random() - 0.5) * 0.4 + timeSeed * 0.2;
                const angle = startAngle + baseAngle + randomOffset;
                
                // è·é›¢ã«ãƒ©ãƒ³ãƒ€ãƒ æ€§ï¼ˆ0.85ã€œ1.15å€ï¼‰
                const distance = radiusKm * (0.85 + Math.random() * 0.3);
                
                const lat = center.lat + (distance / 111) * Math.cos(angle);
                const lng = center.lng + (distance / (111 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle);
                
                waypoints.push({ lat, lng });
            }
            
            waypoints.push(center); // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«æˆ»ã‚‹
            
            console.log('âœ… ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆå®Œäº† - ç›®æ¨™:', targetDistanceKm.toFixed(2), 'km, åŠå¾„:', radiusKm.toFixed(2), 'km');
            return waypoints;
        }

        // OSRM APIã§ãƒ«ãƒ¼ãƒˆã‚’å–å¾—
        async function fetchRoute(waypoints) {
            const coordinates = waypoints.map(w => `${w.lng},${w.lat}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/foot/${coordinates}?overview=full&geometries=geojson`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    return data.routes[0];
                }
                return null;
            } catch (error) {
                console.error('OSRM API ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // Googleãƒãƒƒãƒ—ã§é–‹ã
        function openInGoogleMaps() {
            if (!currentRoute || !userLocation) {
                alert('ã¾ãšãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ«ãƒ¼ãƒˆã®åº§æ¨™ã‚’å–å¾—ï¼ˆé–“å¼•ã„ã¦10ãƒã‚¤ãƒ³ãƒˆç¨‹åº¦ã«ï¼‰
            const coords = currentRoute.geometry.coordinates;
            const step = Math.max(1, Math.floor(coords.length / 8));
            const waypoints = [];
            
            for (let i = step; i < coords.length - step; i += step) {
                if (waypoints.length < 8) { // Googleãƒãƒƒãƒ—ã¯æœ€å¤§9ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆï¼ˆé–‹å§‹ãƒ»çµ‚äº†é™¤ãï¼‰
                    waypoints.push(`${coords[i][1]},${coords[i][0]}`);
                }
            }

            // Googleãƒãƒƒãƒ—ã®ãƒ‡ã‚£ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            const origin = `${userLocation.lat},${userLocation.lng}`;
            const destination = origin;
            const waypointsParam = waypoints.join('|');
            
            // Googleãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªã¾ãŸã¯ã‚¦ã‚§ãƒ–ã§é–‹ã
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypointsParam}&travelmode=walking`;
            
            window.open(url, '_blank');
        }

        // ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
        document.addEventListener('change', function(e) {
            if (e.target.name === 'mapStyle' && map) {
                const style = e.target.value;
                map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                if (style === 'voyager') {
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: 'Â© OpenStreetMap contributors Â© CARTO'
                    }).addTo(map);
                } else {
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                }
            }
        });
    </script>
</body>
</html>
